# Infisical Service
# Depends on: db (Supabase postgres service) and redis from core
# Network: Uses external network localai_default
# Note: depends_on uses service name "db", but connection string uses container name "supabase-db"

networks:
  default:
    external: true
    name: localai_default

services:
  infisical:
    container_name: infisical
    image: infisical/infisical:latest
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    expose:
      - 8080/tcp
    environment:
      - ENCRYPTION_KEY=${INFISICAL_ENCRYPTION_KEY}
      - AUTH_SECRET=${INFISICAL_AUTH_SECRET}
      - DB_CONNECTION_URI=postgresql://postgres:${POSTGRES_PASSWORD}@supabase-db:5432/postgres
      - REDIS_URL=redis://redis:6379
      - SITE_URL=${INFISICAL_SITE_URL:-http://localhost:8010}
      - PORT=8080
      - HOST=0.0.0.0
      - TELEMETRY_ENABLED=false
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

