# Environment File Setup

This guide explains how to set up your `.env` file for the local AI package, including password generation using XKCD-style passphrases.

## Overview

The `.env` file contains configuration and secrets for all services. We use a hybrid approach:

- **Non-sensitive configuration** → Stored in `.env` file (committed to git)
- **Sensitive secrets** → Stored in Infisical (not committed to git)

## Initial Setup

### Step 1: Create `.env` File

Copy the example file (if available) or create from scratch:

```bash
# If .env.example exists
cp .env.example .env

# Or create new file
touch .env
```

### Step 2: Generate Secure Passwords

We use XKCD-style passphrases for better security and memorability. See [Password Generation](#password-generation) below.

### Step 3: Fill in Required Values

See [Required Environment Variables](#required-environment-variables) for the complete list.

## Password Generation

### XKCD-Style Passphrases

XKCD-style passphrases use multiple common words, making them:
- **More secure** - High entropy from word combinations
- **Easier to remember** - Words are more memorable than random characters
- **Easier to type** - No special character confusion

**Example:**
- Weak: `P@ssw0rd123!`
- Strong: `correct-horse-battery-staple` (4 words)
- Very Strong: `correct-horse-battery-staple-dance-moon` (6 words)

### Using the Password Generator

We provide a script to generate XKCD-style passphrases:

```bash
python setup/generate-env-passwords.py
```

This script will:
1. Generate secure passphrases for all required secrets
2. Use a word list (common English words)
3. Combine words with hyphens
4. Output in format ready for `.env` file

**Example output:**
```
Generated passwords for .env file:
====================================

POSTGRES_PASSWORD=correct-horse-battery-staple
JWT_SECRET=dance-moon-river-storm
N8N_ENCRYPTION_KEY=forest-mountain-ocean-sky
...
```

### Manual Password Generation

If you prefer to generate passwords manually:

**Option 1: Using `xkcdpass` (Python package):**
```bash
pip install xkcdpass
xkcdpass -n 4  # Generate 4-word passphrase
```

**Option 2: Using online tools:**
- [Diceware](https://www.rempe.us/diceware/#eff)
- [XKCD Password Generator](https://xkcd.com/936/)

**Option 3: Using word list:**
```bash
# Download word list
wget https://www.eff.org/files/2016/07/18/eff_large_wordlist.txt

# Generate passphrase (Linux/Mac)
shuf -n 4 eff_large_wordlist.txt | awk '{print $2}' | tr '\n' '-' | sed 's/-$//'
```

## Required Environment Variables

### N8N Configuration

```bash
N8N_ENCRYPTION_KEY=<generate-32-char-hex>
N8N_USER_MANAGEMENT_JWT_SECRET=<generate-32-char-hex>
```

**Generation:**
```bash
# Linux/Mac
openssl rand -hex 32

# Windows PowerShell
-join ((1..32) | ForEach-Object { '{0:X2}' -f (Get-Random -Maximum 256) })
```

### Supabase Secrets

```bash
POSTGRES_PASSWORD=<xkcd-passphrase-4-words>
JWT_SECRET=<generate-32-char-hex>
ANON_KEY=<generate-jwt>
SERVICE_ROLE_KEY=<generate-jwt>
DASHBOARD_USERNAME=admin
DASHBOARD_PASSWORD=<xkcd-passphrase-4-words>
POOLER_TENANT_ID=<generate-uuid>
```

**Generation:**
- Passwords: Use XKCD passphrase generator
- JWT_SECRET: `openssl rand -hex 32`
- ANON_KEY and SERVICE_ROLE_KEY: Generated by Supabase setup script
- POOLER_TENANT_ID: `uuidgen` or online UUID generator

### Neo4j Secrets

```bash
NEO4J_AUTH=neo4j/<xkcd-passphrase-4-words>
```

**Format:** `username/password` (default username is `neo4j`)

### MongoDB Secrets

```bash
MONGODB_ROOT_USERNAME=admin
MONGODB_ROOT_PASSWORD=<xkcd-passphrase-4-words>
MONGODB_DATABASE=admin
MONGODB_EXPRESS_USERNAME=admin
MONGODB_EXPRESS_PASSWORD=<xkcd-passphrase-4-words>
```

**MongoDB Express** is a web-based MongoDB admin interface accessible at `mongodb.datacrew.space`. The `MONGODB_EXPRESS_*` credentials are used for HTTP Basic Auth to protect the MongoDB Express UI.

### Langfuse Credentials

```bash
CLICKHOUSE_PASSWORD=<xkcd-passphrase-4-words>
MINIO_ROOT_PASSWORD=<xkcd-passphrase-4-words>
LANGFUSE_SALT=<generate-32-char-hex>
NEXTAUTH_SECRET=<generate-32-char-hex>
ENCRYPTION_KEY=<generate-32-char-hex>
```

### Docker Hub Credentials

```bash
DOCKER_HUB_USERNAME=your-username
DOCKER_HUB_PASSWORD=your-token-or-password
# OR
DOCKER_HUB_TOKEN=your-personal-access-token
```

**Note:** Use Personal Access Token (PAT) instead of password for better security.

### Infisical Configuration

```bash
# Generate with: openssl rand -hex 16
INFISICAL_ENCRYPTION_KEY=<generate-16-char-hex>

# Generate with: openssl rand -base64 32
INFISICAL_AUTH_SECRET=<generate-32-byte-base64>

# For local development
INFISICAL_HOSTNAME=:8010
INFISICAL_SITE_URL=http://localhost:8010

# For production
# INFISICAL_HOSTNAME=infisical.yourdomain.com
# INFISICAL_SITE_URL=https://infisical.yourdomain.com
```

### Open WebUI Google OAuth (Optional)

```bash
# Enable OAuth signup (allows automatic account creation on first Google sign-in)
ENABLE_OAUTH_SIGNUP=true

# Google OAuth Client ID (from Google Cloud Console)
# Note: If CLIENT_ID_GOOGLE_LOGIN is already set (e.g., for Infisical), it will be used automatically
# Otherwise, set GOOGLE_CLIENT_ID:
GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com

# Google OAuth Client Secret (from Google Cloud Console)
# Note: If CLIENT_SECRET_GOOGLE_LOGIN is already set (e.g., for Infisical), it will be used automatically
# Otherwise, set GOOGLE_CLIENT_SECRET:
# Store in Infisical for production!
GOOGLE_CLIENT_SECRET=your-google-client-secret-here

# OpenID Provider URL (required for proper logout functionality)
OPENID_PROVIDER_URL=https://accounts.google.com/.well-known/openid-configuration

# Merge accounts by email (optional - allows logging into account matching OAuth email)
OAUTH_MERGE_ACCOUNTS_BY_EMAIL=true

# Disable login form when OAuth signup is enabled (prevents login issues)
ENABLE_LOGIN_FORM=false
```

**Note**: See `03-apps/open-webui/docs/GOOGLE_OAUTH_SETUP.md` for detailed setup instructions.

### Cloudflare Tunnel (Optional)

```bash
CLOUDFLARE_TUNNEL_TOKEN=<tunnel-token-from-cloudflare>
```

### Hostname Configuration

```bash
# For Cloudflare Tunnel (production)
N8N_HOSTNAME=n8n.yourdomain.com
WEBUI_HOSTNAME=webui.yourdomain.com
FLOWISE_HOSTNAME=flowise.yourdomain.com
SUPABASE_HOSTNAME=supabase.yourdomain.com
OLLAMA_HOSTNAME=ollama.yourdomain.com
SEARXNG_HOSTNAME=searxng.yourdomain.com
LANGFUSE_HOSTNAME=langfuse.yourdomain.com
NEO4J_HOSTNAME=neo4j.yourdomain.com
COMFYUI_HOSTNAME=comfyui.yourdomain.com
INFISICAL_HOSTNAME=infisical.yourdomain.com

# For local development (port-based)
# N8N_HOSTNAME=:8001
# WEBUI_HOSTNAME=:8002
# etc.
```

## Complete .env Template

See the main [README.md](../../README.md) for a complete template with all required variables.

## Syncing with Infisical

### Initial Migration

After creating your `.env` file:

1. **Start Infisical:**
   ```bash
   python start_services.py --profile cpu
   ```

2. **Access Infisical UI:**
   - Navigate to `http://localhost:8010/admin/signup`
   - Create admin account
   - Create organization and project

3. **Migrate Secrets:**
   - Use Infisical UI to add secrets from `.env`
   - Or use CLI: `infisical secrets set KEY value`

4. **Update Workflow:**
   - Remove sensitive secrets from `.env`
   - Keep only non-sensitive configuration
   - Secrets will be fetched from Infisical automatically

### Ongoing Sync

**How it works:**
- `start_services.py` automatically exports secrets from Infisical
- Creates `.env.infisical` file with all secrets
- Docker Compose uses `.env.infisical` for services
- Falls back to `.env` if Infisical unavailable

**Updating secrets:**
1. Update in Infisical UI
2. Restart services: `python start_services.py`
3. New values automatically used

See [00-infrastructure/AGENTS.md](../00-infrastructure/AGENTS.md) for Infisical configuration details.

## Security Best Practices

### Password Strength

- **Use XKCD passphrases** - 4-6 words minimum
- **Mix word types** - Nouns, verbs, adjectives
- **Avoid patterns** - Don't use common phrases
- **Unique per service** - Don't reuse passwords

### Secret Management

- **Never commit `.env`** - Add to `.gitignore`
- **Use Infisical** - For all sensitive secrets
- **Rotate regularly** - Update passwords periodically
- **Limit access** - Only share with trusted team members

### File Permissions

**Linux/Mac:**
```bash
chmod 600 .env  # Read/write for owner only
```

**Windows:**
- Right-click `.env` → Properties → Security
- Remove access for other users

## Validation

### Check Required Variables

Use the validation script (if available):

```bash
python setup/env/validate_env.py
```

This will:
- Check for required variables
- Validate formats
- Warn about missing values
- Suggest improvements

### Manual Validation

**Check all services have required secrets:**
```bash
# N8N
echo $N8N_ENCRYPTION_KEY

# Supabase
echo $POSTGRES_PASSWORD

# etc.
```

## Troubleshooting

### Missing Variables

**Error:** `Variable not set`

**Solution:**
1. Check `.env` file exists
2. Verify variable name (case-sensitive)
3. Check for typos
4. Ensure no extra spaces around `=`

### Invalid Format

**Error:** `Invalid value format`

**Solution:**
- Check password length requirements
- Verify hex strings are correct length
- Ensure no special characters where not allowed

### Secrets Not Loading

**Check:**
1. `.env` file is in project root
2. File permissions are correct
3. No syntax errors (missing quotes, etc.)
4. Services can read the file

## Related Documentation

- [00-infrastructure/AGENTS.md](../00-infrastructure/AGENTS.md) - Infisical configuration
- [Main README](../README.md) - Project overview

## Tools and Resources

- [XKCD Password Generator](https://xkcd.com/936/)
- [Diceware Word List](https://www.eff.org/files/2016/07/18/eff_large_wordlist.txt)
- [xkcdpass Python Package](https://github.com/redacted/XKCD-password-generator)
- [OpenSSL Documentation](https://www.openssl.org/docs/)
