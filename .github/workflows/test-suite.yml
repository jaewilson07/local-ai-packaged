name: Test Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run nightly at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  test-lambda-server:
    name: Lambda Server Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Install dependencies
        working-directory: 04-lambda
        run: |
          uv sync --dev
          uv pip install -e ".[test]" || uv pip install -e .

      - name: Run pytest tests
        working-directory: 04-lambda
        run: |
          if [ -d "tests" ] && [ "$(ls -A tests 2>/dev/null)" ]; then
            uv run pytest tests/ -v --cov=server --cov-report=xml --cov-report=term-missing
          else
            echo "No tests found"
            exit 0
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./04-lambda/coverage.xml
          flags: lambda-server
          name: lambda-server-coverage
          fail_ci_if_error: false

  test-discord-bot:
    name: Discord Bot Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Install dependencies
        working-directory: 03-apps/discord-character-bot
        run: |
          uv sync --dev
          uv pip install -e ".[dev]" || uv pip install -e .

      - name: Run pytest tests
        working-directory: 03-apps/discord-character-bot
        run: |
          if [ -d "tests" ] && [ "$(ls -A tests 2>/dev/null)" ]; then
            uv run pytest tests/ -v
          else
            echo "No tests found"
            exit 0
          fi

  validate-samples:
    name: Validate Sample Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Validate Python syntax in samples
        run: |
          find sample -type f -name "*.py" -exec python3 -m py_compile {} \; || echo "Sample syntax validation issues found"

      - name: Check sample imports
        working-directory: 04-lambda
        run: |
          if [ -d "../sample" ]; then
            # Try to import sample files to check for import errors
            python3 -c "import sys; sys.path.insert(0, '../sample'); import importlib.util" || echo "Sample import check completed"
          fi
