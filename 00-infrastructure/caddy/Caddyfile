{
    # Global options
    auto_https off
    
    # Trust Cloudflare IP ranges for X-Forwarded-* headers
    servers {
        trusted_proxies static 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22 2400:cb00::/32 2606:4700::/32 2803:f800::/32 2405:b500::/32 2405:8100::/32 2a06:98c0::/29 2c0f:f248::/32
    }
}

# --- 1. Define Snippets (Reusable Blocks) ---

# Base security headers for all services
(security_headers_base) {
    header {
        # Prevent MIME sniffing
        X-Content-Type-Options "nosniff"
        # Allow same-origin framing (prevents clickjacking while allowing legitimate embeds)
        X-Frame-Options "SAMEORIGIN"
        # XSS protection (legacy but still useful for older browsers)
        X-XSS-Protection "1; mode=block"
        # Referrer policy - balance privacy and functionality
        Referrer-Policy "strict-origin-when-cross-origin"
        # HSTS - Force HTTPS for 1 year (critical for security)
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # Permissions policy - Disable unnecessary browser features
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=()"
    }
}

# CORS headers specifically for Infisical (only service that needs it)
(infisical_cors) {
    header {
        Access-Control-Allow-Origin "{$INFISICAL_SITE_URL:https://infisical.datacrew.space}"
        Access-Control-Allow-Credentials "true"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    }
}

# CSP for services that serve HTML/JS (adjust per service as needed)
(csp_standard) {
    header {
        # Relaxed CSP to support modern web apps with inline scripts/styles
        # Production deployments should tighten this based on actual requirements
        # Includes Cloudflare Insights for analytics
        # connect-src allows connections to self, https URLs, and api.datacrew.space for MCP/REST API
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://static.cloudflareinsights.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https: https://cloudflareinsights.com https://api.datacrew.space; frame-ancestors 'self';"
    }
}

# Standard proxy headers (without hardcoded protocol)
(standard_proxy) {
    header_up Host {host}
    header_up X-Real-IP {remote}
    header_up X-Forwarded-For {remote}
    header_up X-Forwarded-Proto https
    header_up X-Forwarded-Host {host}
}

# Proxy headers with Origin/Referer preservation (for services that need it)
(proxy_with_origin) {
    header_up Host {host}
    header_up X-Real-IP {remote}
    header_up X-Forwarded-For {remote}
    header_up X-Forwarded-Proto https
    header_up X-Forwarded-Host {host}
    header_up Origin {http.request.header.Origin}
    header_up Referer {http.request.header.Referer}
}

# Standard timeouts for most services
(standard_timeouts) {
    transport http {
        read_timeout 60s
        write_timeout 60s
    }
}

# Extended timeouts for long-running operations (ComfyUI, etc.)
(extended_timeouts) {
    transport http {
        read_timeout 300s
        write_timeout 300s
    }
}

# --- 2. Listen on port 80 for Cloudflare Tunnel ---

:80 {
    # Structured JSON logging to stdout (Docker best practice)
    log {
        output stdout
        format json
        level {$CADDY_LOG_LEVEL:INFO}
    }
    
    # Route based on Host header
    @infisical host infisical.datacrew.space
    handle @infisical {
        # Apply base security headers and CORS
        # NOTE: Not importing csp_standard - let Infisical handle its own CSP
        # Caddy's CSP conflicts with Infisical's built-in CSP headers
        import security_headers_base
        import infisical_cors
        
        # NOTE: Rate limiting requires a third-party Caddy module (e.g., caddy-rate-limit)
        # To enable rate limiting:
        # 1. Build custom Caddy with: xcaddy build --with github.com/mholt/caddy-ratelimit
        # 2. Uncomment the rate_limit directive below
        # 3. Restart Caddy
        #
        # Example rate limiting configuration:
        # route /api/auth/* {
        #     rate_limit {
        #         zone infisical_auth
        #         key {remote_host}
        #         events 10
        #         window 1m
        #     }
        # }
        #
        # Alternative: Use Cloudflare's rate limiting at the edge (recommended for production)
        
        # Global request body size limit for Infisical
        request_body {
            max_size 10MB
        }
        
        # FIX: Infisical frontend bug - add missing Content-Type header for API POST requests
        # The frontend's XHR requests don't set Content-Type, causing 415 errors
        # Note: Fastify patch in 00-infrastructure/infisical/patches/app.mjs handles empty bodies
        @api_post {
            method POST PUT PATCH
            path /api/*
        }
        request_header @api_post Content-Type application/json
        
        # Route to Infisical backend
        reverse_proxy infisical-backend:8080 {
            import proxy_with_origin
            
            # CRITICAL: Force HTTPS protocol header to satisfy NextAuth.js Secure cookie requirements
            # This ensures Infisical sets Secure cookies even though backend receives HTTP
            header_up X-Forwarded-Proto https
            
            # Ensure Origin header matches SITE_URL for Infisical access validation
            header_up Origin {$INFISICAL_SITE_URL:https://infisical.datacrew.space}
            
            # Extended timeouts for Infisical operations
            import extended_timeouts
        }
    }
    
    # n8n route for Cloudflare Tunnel
    @n8n host n8n.datacrew.space
    handle @n8n {
        import security_headers_base
        import csp_standard
        request_body {
            max_size 50MB  # n8n may receive large webhook payloads
        }
        reverse_proxy n8n:5678 {
            import standard_proxy
            import extended_timeouts  # n8n workflows can take time
        }
    }
    
    # ComfyUI route for Cloudflare Tunnel
    @comfyui host comfyui.datacrew.space
    handle @comfyui {
        import security_headers_base
        import csp_standard
        request_body {
            max_size 100MB  # ComfyUI handles large image uploads
        }
        reverse_proxy comfyui:8188 {
            import standard_proxy
            import extended_timeouts  # Image generation takes time
            # flush_interval -1 # Uncomment if you see ComfyUI progress bars freezing
        }
    }
    
    # Neo4j route for Cloudflare Tunnel
    @neo4j host neo4j.datacrew.space
    handle @neo4j {
        import security_headers_base
        import csp_standard
        request_body {
            max_size 10MB
        }
        reverse_proxy neo4j:7474 {
            import standard_proxy
            import standard_timeouts
        }
    }
    
    # Supabase route for Cloudflare Tunnel
    @supabase host supabase.datacrew.space
    handle @supabase {
        import security_headers_base
        import csp_standard
        request_body {
            max_size 50MB  # Supabase storage may handle large files
        }
        reverse_proxy kong:8000 {
            import standard_proxy
            import standard_timeouts
        }
    }
    
    # MongoDB route for Cloudflare Tunnel (MongoDB Express)
    @mongodb host mongodb.datacrew.space
    handle @mongodb {
        import security_headers_base
        import csp_standard
        request_body {
            max_size 10MB
        }
        reverse_proxy mongodb-express:8081 {
            import standard_proxy
            import standard_timeouts
        }
    }
    
    # Qdrant route for Cloudflare Tunnel (Web UI at /dashboard)
    @qdrant host qdrant.datacrew.space
    handle @qdrant {
        import security_headers_base
        import csp_standard
        request_body {
            max_size 10MB
        }
        reverse_proxy qdrant:6333 {
            import standard_proxy
            import standard_timeouts
        }
    }
    
    # Open WebUI route for Cloudflare Tunnel
    @openwebui host openwebui.datacrew.space
    handle @openwebui {
        import security_headers_base
        import csp_standard
        request_body {
            max_size 50MB  # Open WebUI handles file uploads
        }
        reverse_proxy open-webui:8080 {
            import standard_proxy  # Open WebUI doesn't need Origin/Referer preservation
            import extended_timeouts  # LLM responses can take time
        }
    }
    
    # Ollama route for Cloudflare Tunnel
    @ollama host ollama.datacrew.space
    handle @ollama {
        import security_headers_base
        request_body {
            max_size 10MB  # API requests only
        }
        reverse_proxy ollama:11434 {
            import standard_proxy
            import extended_timeouts  # Model inference takes time
        }
    }
    
    # Lambda API route for Cloudflare Tunnel (MongoDB RAG API)
    @lambda_api host api.datacrew.space
    handle @lambda_api {
        import security_headers_base
        request_body {
            max_size 50MB  # Support document uploads for RAG ingestion
        }
        reverse_proxy lambda-server:8000 {
            import standard_proxy
            import extended_timeouts  # RAG operations and LLM responses can take time
        }
    }
    
    # Immich route for Cloudflare Tunnel
    @immich host immich.datacrew.space
    handle @immich {
        import security_headers_base
        import csp_standard
        request_body {
            max_size 500MB  # Support large video uploads
        }
        reverse_proxy immich-server:2283 {
            import standard_proxy
            import extended_timeouts  # Video transcoding takes time
        }
    }
    
    # Frontend route for Cloudflare Tunnel
    @frontend host frontend.datacrew.space
    handle @frontend {
        import security_headers_base
        import csp_standard
        request_body {
            max_size 50MB
        }
        reverse_proxy frontend:3000 {
            import standard_proxy
            import extended_timeouts
        }
    }
    
    # Postman Documentation route for Cloudflare Tunnel
    @postman host postman.datacrew.space
    handle @postman {
        # Redirect to Postman documentation
        redir https://documenter.getpostman.com/view/5049119/UyxbppB2 permanent
    }
    
    # Default handler - routes to services based on Host header
    handle {
        # Return 404 for unmatched hostnames
        respond "No service configured for this hostname" 404
    }
}

# --- 3. Service Definitions (for local development with ports) ---

# N8N
{$N8N_HOSTNAME} {
    import security_headers_base
    import csp_standard
    request_body {
        max_size 50MB
    }
    reverse_proxy n8n:5678 {
        import standard_proxy
        import extended_timeouts
    }
}

# Open WebUI
{$WEBUI_HOSTNAME} {
    import security_headers_base
    import csp_standard
    request_body {
        max_size 50MB
    }
    reverse_proxy open-webui:8080 {
        import standard_proxy
        import extended_timeouts
    }
}

# Flowise
{$FLOWISE_HOSTNAME} {
    import security_headers_base
    import csp_standard
    request_body {
        max_size 10MB
    }
    reverse_proxy flowise:3001 {
        import standard_proxy
        import standard_timeouts
    }
}

# Langfuse
{$LANGFUSE_HOSTNAME} {
    import security_headers_base
    import csp_standard
    request_body {
        max_size 10MB
    }
    reverse_proxy langfuse-web:3000 {
        import standard_proxy
        import standard_timeouts
    }
}

# Supabase
{$SUPABASE_HOSTNAME} {
    import security_headers_base
    import csp_standard
    request_body {
        max_size 50MB
    }
    reverse_proxy kong:8000 {
        import standard_proxy
        import standard_timeouts
    }
}

# Neo4j
{$NEO4J_HOSTNAME} {
    import security_headers_base
    import csp_standard
    request_body {
        max_size 10MB
    }
    reverse_proxy neo4j:7474 {
        import standard_proxy
        import standard_timeouts
    }
}

# ComfyUI
{$COMFYUI_HOSTNAME} {
    import security_headers_base
    import csp_standard
    request_body {
        max_size 100MB
    }
    # basicauth { ... } # Uncomment if not using Cloudflare Access
    reverse_proxy comfyui:8188 {
        import standard_proxy
        import extended_timeouts
        # flush_interval -1 # Uncomment if you see ComfyUI progress bars freezing
    }
}

# Qdrant
{$QDRANT_HOSTNAME} {
    import security_headers_base
    import csp_standard
    request_body {
        max_size 10MB
    }
    reverse_proxy qdrant:6333 {
        import standard_proxy
        import standard_timeouts
    }
}

# Ollama
{$OLLAMA_HOSTNAME} {
    import security_headers_base
    request_body {
        max_size 10MB
    }
    reverse_proxy ollama:11434 {
        import standard_proxy
        import extended_timeouts
    }
}

# Immich
{$IMMICH_HOSTNAME} {
    import security_headers_base
    import csp_standard
    request_body {
        max_size 500MB  # Support large video uploads
    }
    reverse_proxy immich-server:2283 {
        import standard_proxy
        import extended_timeouts  # Video transcoding takes time
    }
}

# Frontend
{$FRONTEND_HOSTNAME} {
    import security_headers_base
    import csp_standard
    request_body {
        max_size 50MB
    }
    reverse_proxy frontend:3000 {
        import standard_proxy
        import extended_timeouts
    }
}

# Infisical (for local port-based access)
# Local access via localhost:8020 (direct port mapping)
# Cloudflare Tunnel routing is handled by the :80 block above

import /etc/caddy/addons/*.conf
