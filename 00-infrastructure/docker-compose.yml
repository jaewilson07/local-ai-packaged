# Infrastructure Stack
# Contains: cloudflared, caddy, infisical-backend, infisical-db, infisical-redis, redis
# Network: Uses external ai-network

volumes:
  caddy-data:
  caddy-config:
  valkey-data:
  cloudflared-config:
  infisical-pg-data:
  infisical-redis-data:

networks:
  default:
    external: true
    name: ai-network

services:
  # Cloudflare Tunnel
  cloudflared:
    container_name: cloudflared
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    command: tunnel run --protocol http2 --token ${CLOUDFLARE_TUNNEL_TOKEN}
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    volumes:
      - cloudflared-config:/etc/cloudflared
    depends_on:
      - caddy
    networks:
      - default
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

  # Caddy Reverse Proxy
  caddy:
    container_name: caddy
    image: docker.io/library/caddy:2-alpine
    restart: unless-stopped
    expose:
      - 80/tcp
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy/caddy-addon:/etc/caddy/addons:ro
      - caddy-data:/data:rw
      - caddy-config:/config:rw
    environment:
      - N8N_HOSTNAME=${N8N_HOSTNAME:-:8001}
      - WEBUI_HOSTNAME=${WEBUI_HOSTNAME:-:8002}
      - FLOWISE_HOSTNAME=${FLOWISE_HOSTNAME:-:8003}
      - OLLAMA_HOSTNAME=${OLLAMA_HOSTNAME:-:8004}
      - SUPABASE_HOSTNAME=${SUPABASE_HOSTNAME:-:8005}
      - SEARXNG_HOSTNAME=${SEARXNG_HOSTNAME:-:8006}
      - LANGFUSE_HOSTNAME=${LANGFUSE_HOSTNAME:-:8007}
      - NEO4J_HOSTNAME=${NEO4J_HOSTNAME:-:8008}
      - COMFYUI_HOSTNAME=${COMFYUI_HOSTNAME:-:8009}
      - INFISICAL_HOSTNAME=${INFISICAL_HOSTNAME:-infisical.datacrew.space}
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    networks:
      - default
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

  # Redis for n8n and other services (separate from Infisical Redis)
  redis:
    container_name: redis
    image: valkey/valkey:8
    command: valkey-server --save 30 1 --loglevel warning
    restart: unless-stopped
    expose:
      - 6379/tcp
    volumes:
      - valkey-data:/data
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
      - DAC_OVERRIDE
    networks:
      - default
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 3s
      timeout: 10s
      retries: 10

  # Infisical PostgreSQL Database (dedicated, separate from Supabase)
  infisical-db:
    container_name: infisical-db
    image: postgres:14-alpine
    restart: unless-stopped
    env_file: 
      - ../.env.global
      - ../.env
    environment:
      - POSTGRES_USER=${INFISICAL_POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${INFISICAL_POSTGRES_PASSWORD}
      - POSTGRES_DB=${INFISICAL_POSTGRES_DB:-postgres}
    volumes:
      - infisical-pg-data:/var/lib/postgresql/data
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "pg_isready --username=${INFISICAL_POSTGRES_USER:-postgres} && psql --username=${INFISICAL_POSTGRES_USER:-postgres} --list"]
      interval: 5s
      timeout: 10s
      retries: 10

  # Infisical Redis (separate from main Redis)
  infisical-redis:
    container_name: infisical-redis
    image: redis:latest
    restart: unless-stopped
    env_file: 
      - ../.env.global
      - ../.env
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
    volumes:
      - infisical-redis-data:/data
    networks:
      - default
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Infisical Backend
  infisical-backend:
    container_name: infisical-backend
    image: infisical/infisical:latest
    restart: unless-stopped
    pull_policy: always
    depends_on:
      infisical-db:
        condition: service_healthy
      infisical-redis:
        condition: service_healthy
    env_file: 
      - ../.env.global
      - ../.env
    expose:
      - 8080/tcp
    environment:
      - NODE_ENV=production
      # These are loaded from env_file, but we also set them here as fallback
      # The env_file loads AFTER variable substitution, so we need explicit values
      - ENCRYPTION_KEY=${INFISICAL_ENCRYPTION_KEY:-4c96d40ba019292350a3caa29f18df83}
      - AUTH_SECRET=${INFISICAL_AUTH_SECRET:-HQtAF8SCAow4+AEP192L1DKhFHu7zmTgCXikf6QUrCM=}
      # DB connection - use URL-encoded password if available, otherwise use regular password
      # Special characters in password need URL encoding
      - DB_CONNECTION_URI=postgresql://${INFISICAL_POSTGRES_USER:-postgres}:${INFISICAL_POSTGRES_PASSWORD_URL_ENCODED:-DmI0F2ykB%2Fq1JFEOKWw4T%2BdSaDFAwlHj6b3yP%2FjTaAw%3D}@infisical-db:5432/${INFISICAL_POSTGRES_DB:-postgres}
      - REDIS_URL=redis://infisical-redis:6379
      # SITE_URL must match the external URL for cookies/sessions to work
      # Override any SITE_URL from env_file to ensure correct HTTPS URL
      - SITE_URL=https://infisical.datacrew.space
      - PORT=8080
      - HOST=0.0.0.0
      - TELEMETRY_ENABLED=false
      # Trust proxy for proper cookie/session handling behind reverse proxy
      - TRUST_PROXY=true
      # Enable HTTPS for secure cookies (we're behind Cloudflare Tunnel with HTTPS)
      - HTTPS_ENABLED=true
      # SMTP Configuration (required for email signup, invitations, password resets)
      # To enable email functionality, configure these variables:
      # SMTP_HOST=smtp.sendgrid.net (or your SMTP provider)
      # SMTP_PORT=587
      # SMTP_USERNAME=your_smtp_username
      # SMTP_PASSWORD=your_smtp_password
      # SMTP_FROM_ADDRESS=your_email@example.com
      # SMTP_FROM_NAME=Infisical
      # Currently unset to prevent DNS timeouts during login
      # These were causing 8000+ second delays when trying to send emails
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-}
      - SMTP_USERNAME=${SMTP_USERNAME:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM_ADDRESS=${SMTP_FROM_ADDRESS:-}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-Infisical}
      # Google OAuth/SSO Configuration (optional)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/api/status || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

