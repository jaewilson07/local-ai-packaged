# Infrastructure Stack
# Contains: cloudflared, caddy, redis
# Network: Uses external ai-network
# Note: Infisical has been moved to external standalone project but Caddy still routes to it

# Shared configuration anchors
x-logging-json: &logging-json
  driver: "json-file"
  options:
    max-size: "1m"
    max-file: "1"

x-security-network: &security-network
  cap_drop:
    - ALL
  cap_add:
    - NET_BIND_SERVICE
  security_opt:
    - no-new-privileges:true

x-security-usergroup: &security-usergroup
  cap_drop:
    - ALL
  cap_add:
    - SETGID
    - SETUID
    - DAC_OVERRIDE
  security_opt:
    - no-new-privileges:true

x-healthcheck-fast: &healthcheck-fast
  interval: 5s
  timeout: 5s
  retries: 3
  start_period: 10s

networks:
  default:
    external: true
    name: ai-network

volumes:
  caddy-data:
  caddy-config:
  valkey-data:
  cloudflared-config:

services:
  # Cloudflare Tunnel
  cloudflared:
    container_name: cloudflared
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    command: tunnel run --protocol http2 --token ${CLOUDFLARE_TUNNEL_TOKEN}
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    volumes:
      - cloudflared-config:/etc/cloudflared
    depends_on:
      - caddy
    networks:
      - default
    logging: *logging-json

  # Caddy Reverse Proxy
  caddy:
    container_name: caddy
    image: docker.io/library/caddy:2-alpine
    restart: unless-stopped
    expose:
      - 80/tcp
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy/caddy-addon:/etc/caddy/addons:ro
      - caddy-data:/data:rw
      - caddy-config:/config:rw
    environment:
      # Service hostnames for local development
      - N8N_HOSTNAME=${N8N_HOSTNAME:-:8001}
      - WEBUI_HOSTNAME=${WEBUI_HOSTNAME:-:8002}
      - FLOWISE_HOSTNAME=${FLOWISE_HOSTNAME:-:8003}
      - OLLAMA_HOSTNAME=${OLLAMA_HOSTNAME:-:8004}
      - SUPABASE_HOSTNAME=${SUPABASE_HOSTNAME:-:8005}
      - SEARXNG_HOSTNAME=${SEARXNG_HOSTNAME:-:8006}
      - LANGFUSE_HOSTNAME=${LANGFUSE_HOSTNAME:-:8007}
      - NEO4J_HOSTNAME=${NEO4J_HOSTNAME:-:8008}
      - COMFYUI_HOSTNAME=${COMFYUI_HOSTNAME:-:8009}
      - QDRANT_HOSTNAME=${QDRANT_HOSTNAME:-:8010}
      - IMMICH_HOSTNAME=${IMMICH_HOSTNAME:-:2283}
      - FRONTEND_HOSTNAME=${FRONTEND_HOSTNAME:-:8011}
      # Infisical configuration for CORS
      - INFISICAL_SITE_URL=${INFISICAL_SITE_URL:-https://infisical.datacrew.space}
      # Logging configuration (INFO, WARN, ERROR, DEBUG)
      - CADDY_LOG_LEVEL=${CADDY_LOG_LEVEL:-INFO}
    <<: *security-network
    networks:
      - default
    logging: *logging-json
    healthcheck:
      # Health check using dedicated /health endpoint
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:80/health || exit 1"]
      <<: *healthcheck-fast

  # Redis for n8n and other services
  redis:
    container_name: redis
    image: valkey/valkey:8
    command: valkey-server --save 30 1 --loglevel warning
    restart: unless-stopped
    expose:
      - 6379/tcp
    volumes:
      - valkey-data:/data
    <<: *security-usergroup
    networks:
      - default
    logging: *logging-json
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 3s
      timeout: 10s
      retries: 10
